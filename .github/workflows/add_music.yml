name: Add music to final video

on:
  repository_dispatch:
    types: [add_music]

jobs:
  add_music:
    runs-on: ubuntu-22.04
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps
        shell: bash
        run: |
          set -euo pipefail
          sudo rm -f /var/lib/apt/lists/lock /var/cache/apt/archives/lock /var/lib/dpkg/lock*
          sudo dpkg --configure -a || true
          sudo apt-get -o Acquire::Retries=5 update
          sudo apt-get -o Acquire::Retries=5 install -y --no-install-recommends ffmpeg
          ffmpeg -version | head -n 2

      - name: Download final video + music from R2
        shell: bash
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: auto
          R2_ENDPOINT: https://${{ secrets.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com
          BUCKET: ${{ secrets.R2_BUCKET }}
          VIDEO_KEY: ${{ github.event.client_payload.video_key }}
          MUSIC_KEY: ${{ github.event.client_payload.music_key }}
        run: |
          set -euo pipefail
          if [ -z "${BUCKET:-}" ]; then echo "Missing secret: R2_BUCKET"; exit 1; fi
          if [ -z "${VIDEO_KEY:-}" ]; then echo "Missing payload: video_key"; exit 1; fi
          if [ -z "${MUSIC_KEY:-}" ]; then echo "Missing payload: music_key"; exit 1; fi

          echo "Downloading video: s3://$BUCKET/$VIDEO_KEY"
          aws --endpoint-url "$R2_ENDPOINT" s3 cp "s3://$BUCKET/$VIDEO_KEY" ./in.mp4

          echo "Downloading music: s3://$BUCKET/$MUSIC_KEY"
          aws --endpoint-url "$R2_ENDPOINT" s3 cp "s3://$BUCKET/$MUSIC_KEY" ./music_in

          ls -lh

      - name: Mix music (loop) + duck under original audio
        shell: bash
        run: |
          set -euo pipefail

          # Проверим, есть ли аудио в исходном видео
          HAS_AUDIO=$(ffprobe -v error -select_streams a:0 -show_entries stream=index -of csv=p=0 in.mp4 || true)
          echo "HAS_AUDIO=$HAS_AUDIO"

          if [ -z "$HAS_AUDIO" ]; then
            echo "No audio track in video -> music only"

            cat > graph.txt <<'EOF'
[1:a]aformat=fltp:44100:stereo,volume=0.12[aout]
EOF

            ffmpeg -y \
              -i in.mp4 \
              -stream_loop -1 -i music_in \
              -filter_complex_script graph.txt \
              -map 0:v -map "[aout]" \
              -c:v copy -c:a aac -b:a 192k \
              -shortest out_music.mp4

          else
            echo "Audio track exists -> duck music under voice"

            cat > graph.txt <<'EOF'
[0:a]aformat=fltp:44100:stereo,volume=1.0[voice]
[1:a]aformat=fltp:44100:stereo,volume=0.12[music]
[music][voice]sidechaincompress=threshold=0.06:ratio=10:attack=10:release=2000[musicduck]
[voice][musicduck]amix=inputs=2:normalize=0[aout]
EOF

            ffmpeg -y \
              -i in.mp4 \
              -stream_loop -1 -i music_in \
              -filter_complex_script graph.txt \
              -map 0:v -map "[aout]" \
              -c:v copy -c:a aac -b:a 192k \
              -shortest out_music.mp4
          fi

          ls -lh out_music.mp4

      - name: Upload back to R2
        shell: bash
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: auto
          R2_ENDPOINT: https://${{ secrets.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com
          BUCKET: ${{ secrets.R2_BUCKET }}
          VIDEO_ID: ${{ github.event.client_payload.video_id }}
        run: |
          set -euo pipefail
          if [ -z "${BUCKET:-}" ]; then echo "Missing secret: R2_BUCKET"; exit 1; fi

          if [ -z "${VIDEO_ID:-}" ]; then
            VIDEO_ID="$(date +%s)_$RANDOM"
          fi

          OUT_KEY="final/${VIDEO_ID}_subbed_music.mp4"
          aws --endpoint-url "$R2_ENDPOINT" s3 cp ./out_music.mp4 "s3://$BUCKET/$OUT_KEY"
          echo "Uploaded: $OUT_KEY"
